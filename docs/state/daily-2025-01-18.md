# Daily Plan - 2025-01-18

## Executive Summary

**Goal:** Complete GDELT-shaped signals migration (Issue #16)

**Current State:** Backend foundation complete, endpoints and flow_detector still using old Topic model

**Branch:** `feat/gdelt-shaped-signals`

**Estimated Completion:** ~2.5 hours of focused work

---

## Priority Stack

### 1. [URGENT] Update Backend Endpoints - Flow Detector Adapter Layer
**Owner:** backend-flow-engineer
**Time:** 45 min
**Reason:** Unblocks all downstream work - frontend cannot render without working endpoints

**Critical Path Item** - All other tasks depend on this completing first.

### 2. [HIGH] Update flow_detector.py for GDELTSignal
**Owner:** backend-flow-engineer
**Time:** 30 min
**Reason:** Core algorithm change from Topic.label to GDELTSignal.themes

### 3. [HIGH] Frontend TypeScript Types Update
**Owner:** frontend-map-engineer
**Time:** 30 min
**Reason:** Cannot consume new GDELT data without matching types

### 4. [MEDIUM] End-to-End Testing
**Owner:** backend-flow-engineer + frontend-map-engineer
**Time:** 30 min
**Reason:** Verify complete pipeline works before cleanup

### 5. [LOW] Cleanup and Documentation
**Owner:** orchestrator
**Time:** 15 min
**Reason:** Remove dead code paths, update docs

---

## Agent Assignments

| Agent | Task | File Path | Expected Output | ETA |
|-------|------|-----------|-----------------|-----|
| backend-flow-engineer | Endpoint adapter layer | `/backend/app/api/v1/flows.py` | Transform `fetch_gdelt_signals()` -> `detect_flows()` with Topic adapter | 45 min |
| backend-flow-engineer | Endpoint adapter layer | `/backend/app/api/v1/hexmap.py` | Same adapter pattern for hexmap | (included) |
| backend-flow-engineer | FlowDetector GDELT update | `/backend/app/services/flow_detector.py` | Support both Topic (adapter) and GDELTSignal input | 30 min |
| frontend-map-engineer | TypeScript interfaces | `/frontend/src/lib/mapTypes.ts` | GDELTSignal-aware types (optional - see analysis) | 30 min |
| orchestrator | E2E testing | curl + browser | Verify flows/hexmap render correctly | 30 min |
| orchestrator | Cleanup & docs | Multiple files | Remove old code paths, update ADR | 15 min |

---

## Detailed Task Breakdown

### Task 1: Backend Endpoints - Adapter Layer Pattern

**File:** `/Users/pedro/Desktop/PEDRO/Cursos/ObservatorioGlobal/backend/app/api/v1/flows.py`

**Problem Analysis:**
- Currently calls `signals_service.fetch_trending_signals()` (returns `Topic` objects)
- Need to call `signals_service.fetch_gdelt_signals()` (returns `GDELTSignal` objects)
- `flow_detector.detect_flows()` expects `Dict[str, Tuple[List[Topic], datetime]]`

**Solution: Adapter Function**
Create a `gdelt_signal_to_topic_adapter()` function that transforms:
```python
GDELTSignal -> Topic
```

This preserves flow_detector compatibility while using new GDELT data.

**Required Changes:**

```python
# Line 87 - Replace fetch_trending_signals with fetch_gdelt_signals
gdelt_signals = await signals_service.fetch_gdelt_signals(
    countries=country_list,
    time_window=time_window,
    use_cache=True,
)

# Add adapter function to convert GDELTSignal -> Topic for flow_detector
def gdelt_signal_to_topic(signal: GDELTSignal) -> Topic:
    """Convert GDELT signal to Topic for flow detector compatibility."""
    # Use theme_labels instead of raw codes for TF-IDF
    return Topic(
        id=signal.signal_id,
        label=signal.primary_theme,  # Or join theme_labels
        count=sum(signal.theme_counts.values()),
        sample_titles=[],  # Not used by flow_detector
        sources=["gdelt"],
        confidence=signal.confidence
    )

# Transform signals_by_country to trends_by_country for flow_detector
trends_by_country = {}
for country, (signals, timestamp) in gdelt_signals.items():
    topics = [gdelt_signal_to_topic(s) for s in signals]
    trends_by_country[country] = (topics, timestamp)
```

**File:** `/Users/pedro/Desktop/PEDRO/Cursos/ObservatorioGlobal/backend/app/api/v1/hexmap.py`

**Same pattern - lines 182-187**

**Acceptance Criteria:**
- [ ] Endpoints call `fetch_gdelt_signals()` instead of `fetch_trending_signals()`
- [ ] Adapter function correctly transforms GDELTSignal -> Topic
- [ ] Flow detector receives properly formatted input
- [ ] API responses maintain same structure (FlowsResponse, HexmapResponse)

---

### Task 2: Update flow_detector.py

**File:** `/Users/pedro/Desktop/PEDRO/Cursos/ObservatorioGlobal/backend/app/services/flow_detector.py`

**Analysis Result:** MINIMAL CHANGES NEEDED

The flow_detector already works with `Topic` objects through the adapter pattern. Key locations:

- **Line 11:** Import stays as `from app.models.schemas import Topic`
- **Line 133-180:** `calculate_hotspot_intensity()` uses `t.count` and `t.confidence` - compatible
- **Line 207-245:** Hotspot creation uses `t.label`, `t.count`, `t.confidence` - compatible
- **Line 269-270:** `labels_a = [t.label for t in topics_a]` - compatible if adapter sets `label=primary_theme`

**Required Change:** Consider using multiple themes instead of single label

**Option A (Minimal - Recommended for MVP):**
Keep adapter setting `label=primary_theme` - flow detection uses primary theme only.

**Option B (Enhanced - Future):**
Update adapter to create multiple Topics per signal (one per theme) for richer flow detection.

**For MVP, use Option A** - single `label=primary_theme` in adapter.

**Acceptance Criteria:**
- [ ] flow_detector.py continues working with Topic adapter
- [ ] Hotspots display theme labels (not raw GDELT codes)
- [ ] Shared topics between countries are meaningful labels

---

### Task 3: Frontend TypeScript Types

**File:** `/Users/pedro/Desktop/PEDRO/Cursos/ObservatorioGlobal/frontend/src/lib/mapTypes.ts`

**Analysis Result:** NO CHANGES REQUIRED FOR MVP

**Why:** The frontend receives transformed data in `FlowsResponse` format:
- `CountryHotspot` with `top_topics: Array<{label, count}>`
- `Flow` with `shared_topics: string[]`

The GDELTSignal transformation happens on backend - frontend never sees GDELTSignal directly.

**Current mapTypes.ts is already compatible** because:
1. Backend transforms GDELTSignal -> Topic -> Hotspot/Flow
2. FlowsResponse structure unchanged
3. Frontend displays labels from `top_topics[].label`

**Future Enhancement (Not MVP):**
If frontend needs to display GDELT-specific data (themes, tone, sentiment):
- Add `GDELTSignal` interface
- Add `GDELTTone` interface
- Add API endpoint for raw signals

**For MVP:** Verify existing types work correctly by testing.

**Acceptance Criteria:**
- [ ] FlowsResponse renders in Classic View
- [ ] HexmapResponse renders in Heatmap View
- [ ] top_topics display meaningful theme labels
- [ ] shared_topics display meaningful theme labels

---

### Task 4: End-to-End Testing

**Backend Testing:**
```bash
# Start services (if not running)
cd /Users/pedro/Desktop/PEDRO/Cursos/ObservatorioGlobal
docker-compose up -d

# Test flows endpoint
curl -s http://localhost:8000/v1/flows | jq '.hotspots[0].top_topics, .flows[0].shared_topics'

# Test hexmap endpoint
curl -s http://localhost:8000/v1/hexmap | jq '.metadata, .hexes | length'

# Verify GDELT themes appear (not random strings)
curl -s http://localhost:8000/v1/flows | jq '.hotspots[].top_topics[].label'
# Expected: Real theme labels like "Economic Inflation", "Terrorism", "Climate Change"
```

**Frontend Testing:**
1. Open browser to http://localhost:5173
2. Verify Classic View loads and shows flow arcs
3. Verify hotspots display theme labels on hover
4. Switch to Heatmap View
5. Verify hexmap renders with proper intensities
6. Change time window - verify data refreshes

**Acceptance Criteria:**
- [ ] Backend endpoints return valid JSON
- [ ] Theme labels are human-readable (not GDELT codes)
- [ ] Classic View shows flows between countries
- [ ] Hotspot tooltips show top themes
- [ ] Heatmap View renders hexagons
- [ ] No console errors in browser

---

### Task 5: Cleanup and Documentation

**Remove Dead Code:**
- `flows.py` line 133-141: `_generate_fallback_data()` function (no longer used)

**Update Documentation:**
- Create ADR for GDELT signal migration decision

**Update .env.example:**
- No new env vars needed for this migration

**Acceptance Criteria:**
- [ ] No dead code paths
- [ ] ADR documents migration decision
- [ ] README updated if needed

---

## Dependencies Map

```
Task 1 (Endpoints)
    |
    v
Task 2 (FlowDetector) -----> Task 3 (Frontend Types)
    |                              |
    +----------+-------------------+
               |
               v
         Task 4 (E2E Testing)
               |
               v
         Task 5 (Cleanup)
```

**Critical Path:** Task 1 -> Task 4 (frontend can be tested immediately after endpoints)

---

## Risks to Monitor

### Risk 1: Theme Label Quality
**Category:** Data
**Likelihood:** Medium
**Impact:** Medium
**Description:** If adapter uses raw GDELT codes (TAX_TERROR) instead of labels (Terrorism), UI will be confusing

**Mitigation:**
- Adapter must use `theme_labels` list, not `themes` list
- Use `gdelt_taxonomy.get_theme_label()` for conversion
- Test with curl to verify human-readable labels

### Risk 2: TF-IDF Similarity Degradation
**Category:** Algorithm
**Likelihood:** Low
**Impact:** Medium
**Description:** Using single `primary_theme` instead of all themes may reduce flow detection quality

**Mitigation:**
- MVP uses single theme per signal (acceptable for demo)
- Future: Create multiple Topic objects per signal for richer similarity
- Monitor flow quality in testing

### Risk 3: Cache Key Mismatch
**Category:** Integration
**Likelihood:** Low
**Impact:** Low
**Description:** Old cache data (Topic format) vs new cache data (GDELTSignal format)

**Mitigation:**
- GDELT signals use different cache key prefix (`gdelt:` vs `signals:`)
- Clear Redis cache during testing: `redis-cli FLUSHDB`

### Risk 4: Missing Import
**Category:** Code
**Likelihood:** Low
**Impact:** High (compile error)
**Description:** Forgetting to import GDELTSignal, Topic in endpoint files

**Mitigation:**
- Check imports before running
- Required: `from app.models.gdelt_schemas import GDELTSignal`
- Required: `from app.models.schemas import Topic`

---

## Blockers

**None identified.** All prerequisites complete:
- [x] GDELTSignal schema exists
- [x] GDELT taxonomy exists
- [x] Placeholder generator exists
- [x] SignalsService.fetch_gdelt_signals() exists
- [x] GDELTClient.fetch_gdelt_signals() exists

---

## Session Workflow

### Phase 1: Backend Updates (75 min)

1. **Read current state** (already done in this planning)
   - Understood endpoint structure
   - Understood flow_detector structure
   - Identified adapter pattern approach

2. **Implement adapter function**
   - Create `gdelt_signal_to_topic()` utility
   - Update flows.py lines 85-90
   - Update hexmap.py lines 180-190

3. **Test backend isolation**
   ```bash
   curl http://localhost:8000/v1/flows
   curl http://localhost:8000/v1/hexmap
   ```

### Phase 2: Frontend Verification (30 min)

4. **Verify existing types work**
   - Load frontend in browser
   - Check console for errors
   - Test both view modes

5. **If types need update** (unlikely)
   - Add GDELTSignal interface
   - Update API response types

### Phase 3: Testing & Cleanup (45 min)

6. **E2E testing**
   - Full flow verification
   - Edge cases (empty data, cache behavior)

7. **Cleanup**
   - Remove dead code
   - Create ADR
   - Update handoff doc

8. **Create PR** (if all tests pass)

---

## Definition of Done

Issue #16 is complete when:

- [ ] Backend compiles and runs without errors
- [ ] `/v1/flows` returns GDELTSignal-derived data with human-readable labels
- [ ] `/v1/hexmap` returns GDELTSignal-derived hexmap data
- [ ] Classic View renders flows correctly
- [ ] Heatmap View renders hexagons correctly
- [ ] Hotspot tooltips show theme labels (not GDELT codes)
- [ ] No dead code paths remain
- [ ] ADR documents migration decision
- [ ] Handoff notes complete
- [ ] PR created to main branch

---

## Reference Files

### Backend Files to Modify
1. `/Users/pedro/Desktop/PEDRO/Cursos/ObservatorioGlobal/backend/app/api/v1/flows.py` - Add adapter, update service call
2. `/Users/pedro/Desktop/PEDRO/Cursos/ObservatorioGlobal/backend/app/api/v1/hexmap.py` - Same adapter pattern

### Backend Files for Reference
3. `/Users/pedro/Desktop/PEDRO/Cursos/ObservatorioGlobal/backend/app/models/gdelt_schemas.py` - GDELTSignal structure
4. `/Users/pedro/Desktop/PEDRO/Cursos/ObservatorioGlobal/backend/app/models/schemas.py` - Topic structure
5. `/Users/pedro/Desktop/PEDRO/Cursos/ObservatorioGlobal/backend/app/services/signals_service.py` - fetch_gdelt_signals()
6. `/Users/pedro/Desktop/PEDRO/Cursos/ObservatorioGlobal/backend/app/core/gdelt_taxonomy.py` - Theme labels

### Frontend Files (Verify Only)
7. `/Users/pedro/Desktop/PEDRO/Cursos/ObservatorioGlobal/frontend/src/lib/mapTypes.ts` - Should work as-is
8. `/Users/pedro/Desktop/PEDRO/Cursos/ObservatorioGlobal/frontend/src/store/mapStore.ts` - Fetch logic

### Documentation
9. `/Users/pedro/Desktop/PEDRO/Cursos/ObservatorioGlobal/docs/state/HANDOFF-2025-01-15.md` - Previous session context

---

## Key Code Snippets

### Adapter Function (to add to flows.py)

```python
from app.models.gdelt_schemas import GDELTSignal
from app.models.schemas import Topic

def gdelt_signal_to_topic(signal: GDELTSignal) -> Topic:
    """
    Convert GDELT signal to Topic for flow detector compatibility.

    Uses theme_labels (human-readable) not themes (raw codes).
    """
    # Calculate total count from theme_counts
    total_count = sum(signal.theme_counts.values()) if signal.theme_counts else 1

    # Use primary theme label as the topic label
    # theme_labels contains human-readable names like "Economic Inflation"
    primary_label = signal.theme_labels[0] if signal.theme_labels else signal.primary_theme

    return Topic(
        id=signal.signal_id,
        label=primary_label,
        count=total_count,
        sample_titles=[],  # Not used by flow_detector
        sources=["gdelt"],
        confidence=signal.confidence
    )
```

### Updated Endpoint Call Pattern

```python
# In flows.py get_flows() function, replace lines 85-91:

# Fetch GDELT signals using unified service
signals_service = get_signals_service()
gdelt_signals = await signals_service.fetch_gdelt_signals(
    countries=country_list,
    time_window=time_window,
    use_cache=True,
)

# Transform to Topic format for flow_detector compatibility
trends_by_country = {}
for country, (signals, timestamp) in gdelt_signals.items():
    topics = [gdelt_signal_to_topic(s) for s in signals]
    trends_by_country[country] = (topics, timestamp)

if len(trends_by_country) < 2:
    # ... rest of function unchanged
```

---

## Success Metrics

1. **Functionality:** All tests pass, both views render
2. **Quality:** Theme labels human-readable (not raw GDELT codes)
3. **Performance:** Similar response times to previous implementation
4. **Code Quality:** Clean adapter pattern, no duplication

---

## Notes for Next Session

If this session doesn't complete all tasks:

1. **Minimum viable checkpoint:** Complete Task 1 (endpoints) + Task 4 (backend testing)
2. **Frontend can wait:** Types don't need changes for MVP
3. **Cleanup can wait:** Focus on functionality first

**Time estimate if interrupted:** Save 30 min buffer for unexpected issues.

---

## Document Metadata

**Created:** 2025-01-18
**Author:** Orchestrator Agent
**Issue:** #16 - GDELT-Shaped Placeholders
**Branch:** feat/gdelt-shaped-signals
**Previous:** HANDOFF-2025-01-15.md
