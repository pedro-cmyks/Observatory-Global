# Handoff - 2025-11-24

## Session Summary
**Branch:** `feat/radar-visualization-v2`
**Status:** Stable checkpoint - radar visualization baseline established
**Next Session:** Continue from this branch for projection decision and visual polish

## What Currently Works ✅

### Map Visualization
- **Base Map:** Mapbox with Mercator projection (standard Web Mercator EPSG:3857)
- **Circles (Markers):** Rendering at country centroids with proper sizing
- **Arcs (Flows):** Rendering between countries with curved paths
- **Layer Toggles:** Working controls for heatmap, flows, and markers
- **Data Flow:** Backend `/v1/flows` endpoint returning real GDELT data (19 hotspots, flows)
- **Zoom Scaling:** Dynamic layer sizing based on zoom level (exponential formula: 2^(zoom-2))

### Architecture
- **Integration Pattern:** DeckGL component wrapping Mapbox Map with shared viewState
- **Layers:** ScatterplotLayer for circles, ArcLayer for flows
- **State Management:** Zustand store with layer visibility toggles
- **Controls:** Top control bar with layer toggles, time window selector

### Files Modified (Need to Commit)
```
frontend/src/components/GlobalObservatory/GlobalObservatory.tsx  # Removed globe projection
frontend/src/components/GlobalObservatory/MapLayerManager.tsx    # Added zoom scaling
docs/adrs/ADR-0004-map-projection-strategy.md                   # NEW: Projection decision doc
docs/frontend/ARCHITECTURE-FRONTEND-RADAR-V1.md                  # Updated projection notes
```

## What Is NOT Decided Yet ⚠️

### Projection Choice (Open Decision)
We have **NOT** finalized whether the visualization will use:
- ❓ **Globe projection** (3D spinning sphere)
- ❓ **Mercator projection** (flat map, current state)
- ❓ **Switchable mode** (toggle between globe and flat)

**Current State:** Mercator projection (flat map) to fix coordinate system mismatch
**Reason:** Mapbox globe + deck.gl had "floating layers" issue (see ADR-0004)
**Future Options:** Could explore deck.gl native GlobeView for true 3D globe with proper layer alignment

### Still Missing / Incomplete
- **True Heatmap Layer:** Gaussian weather-radar style visualization not fully implemented
- **Visual Polish:** Colors, opacity, sizes need refinement
- **Hover Tooltips:** Not yet implemented for markers
- **Click Interaction:** Sidebar panel doesn't open on marker click
- **Time Window Integration:** Selector exists but needs backend wiring verification

## Technical Context

### The "Floating Layers" Problem (Now Resolved)
**Issue:** When using Mapbox globe projection, deck.gl layers appeared to float on an "inner sphere" and drifted when rotating the globe.

**Root Cause:** Mapbox's 3D globe projection and deck.gl's 2D coordinate projection used incompatible projection matrices.

**Current Solution:** Switched to Mercator projection (no globe) so both Mapbox and deck.gl use the same coordinate system.

**Documentation:** See `docs/adrs/ADR-0004-map-projection-strategy.md` for full technical analysis and alternatives.

### Key Architecture Decisions
1. **MapboxOverlay vs DeckGL Component:** Chose DeckGL wrapping Map for better viewState control
2. **Zoom-Based Scaling:** Implemented exponential scaling (2^(zoom-2)) for responsive layer sizing
3. **Layer Ordering:** Flows → Heatmap → Markers (z-ordering via array position)
4. **Depth Testing:** Enabled depthTest and depthMask for proper 3D rendering

## Commands to Resume Work

```bash
# Navigate to project
cd /Users/pedro/Desktop/PEDRO/Cursos/ObservatorioGlobal

# Ensure you're on the correct branch
git checkout feat/radar-visualization-v2

# Pull any remote changes (if working from different machine)
git pull origin feat/radar-visualization-v2

# Check what needs committing
git status

# Commit current state (if not already done)
git add docs/adrs/ADR-0004-map-projection-strategy.md
git add docs/frontend/ARCHITECTURE-FRONTEND-RADAR-V1.md
git commit -m "docs: add ADR-0004 for map projection decision and update architecture notes"

# Push to remote
git push origin feat/radar-visualization-v2

# Start servers
# Terminal 1: Backend
cd backend
source .venv/bin/activate
uvicorn app.main:app --reload --port 8000

# Terminal 2: Frontend
cd frontend
npm run dev

# Open browser
# http://localhost:5173
```

## Next Session Priorities

### Immediate Tasks
1. **Visual Verification:** Load http://localhost:5173 and verify circles/arcs render correctly
2. **Projection Decision:** Decide if we keep Mercator or explore alternatives
   - If keeping flat: Polish current implementation
   - If wanting globe: Research deck.gl GlobeView integration
3. **Heatmap Implementation:** Implement true Gaussian weather-radar style layer

### Future Work
4. **Hover Tooltips:** Show country name, intensity, topics on marker hover
5. **Click Interaction:** Open sidebar with narrative details on marker click
6. **Time Window Wiring:** Verify time selector actually fetches different data
7. **Visual Polish:** Refine colors, opacity, sizes for professional look
8. **Performance Testing:** Verify smooth rendering at all zoom levels

## Known Issues / Blockers
- **Git Lock:** Git commands were hanging during this session (index.lock file issue)
  - **Solution:** Run `rm -f .git/index.lock` if git commands hang
- **Browser Cache:** May need hard refresh (Ctrl+Shift+R) to see latest changes
- **Vite Cache:** Run `rm -rf frontend/node_modules/.vite` if seeing stale builds

## Success Metrics (Current State)
- ✅ Backend serving real GDELT data
- ✅ Circles rendering at correct geographic positions
- ✅ Flows rendering as curved arcs between countries
- ✅ Layer toggles functional
- ✅ Zoom scaling working (layers resize appropriately)
- ✅ No console errors or deck.gl assertions failing
- ⚠️ Projection choice deferred (intentional)
- ⚠️ Heatmap needs work (expected)

## Reference Documents
- **ADR-0004:** Map projection strategy and technical rationale
- **Architecture Doc:** Frontend radar architecture (updated today)
- **Previous Handoff:** `docs/state/HANDOFF-2025-11-22.md` (documented "inner sphere" problem)
- **Known Issues:** `docs/KNOWN_ISSUES.md` (may need updating once issues resolved)

## Notes for Next Developer
- This branch represents a **stable baseline** for radar visualization work
- Code is in a working state (circles + arcs render)
- Major architectural decisions (projection, heatmap style) are intentionally open
- Do NOT merge to main yet - this is experimental visualization work
- Feel free to switch projection approaches if better solution found
- All layer code is in `frontend/src/components/GlobalObservatory/`

---

**Session End:** 2025-11-24
**Developer:** Claude Code (with user feedback)
**Next Steps:** Resume from this checkpoint in next session
