# System Audit - Observatory Global Radar Rebuild
**Date:** 2025-11-22  
**Status:** Phase 0 Complete - Ground Truth Established  
**Context:** Pre-execution audit before multi-phase rebuild

---

## Executive Summary

### Current State Assessment

**Good News:**
- âœ… Full stack (Docker) is healthy and running
- âœ… Real GDELT integration exists and is partially working
- âœ… Backend API returns structured data with proper metadata
- âœ… Frontend layers (flows, heatmap, nodes) are architecturally correct
- âœ… Phase 3.5 actor data (persons, organizations, outlets) is implemented

**Critical Issues:**
1. **Visual Bugs:** Flows have z-ordering/radius problems (floating artifacts off globe)
2. **Invisibility:** Flows barely visible at global zoom despite pixel-based sizing
3. **Heatmap Broken:** Gaussian layer not rendering or hidden
4. **Data Source Confusion:** Unclear if using real GDELT or placeholders in production
5. **Narrative Disconnect:** UI feels fragmented; Classic vs Heatmap views look too similar

---

## 1. Data Pipeline Architecture

### Current Flow: GDELT â†’ Backend â†’ API â†’ Frontend

```mermaid
graph LR
    A[GDELT 2.0 GKG Files<br/>15-min updates] --> B{GDELTClient}
    B --> C[Real Data Path]
    B --> D[Placeholder Fallback]
    
    C --> E[GDELTDownloader]
    E --> F[GDELTParser]
    F --> G[GDELTAdapter]
    G --> H[GDELTSignal List]
    
    D --> I[PlaceholderGenerator]
    I --> H
    
    H --> J[SignalsService<br/>15-min cache]
    J --> K[FlowDetector<br/>TF-IDF + time decay]
    K --> L[/v1/flows API]
    
    L --> M[Frontend MapStore]
    M --> N[DeckGL Layers]
    N --> O[Mapbox Globe]
    
    style C fill:#10b981
    style D fill:#f59e0b
    style J fill:#3b82f6
    style N fill:#8b5cf6
```

### Data Source Status

**Backend Implementation:**
- **File:** `backend/app/services/gdelt_client.py`
- **Strategy:** Download real GDELT â†’ Parse â†’ Cache for 15 min â†’ Fallback to placeholder on error
- **Current Behavior:** LIKELY using placeholders (need to verify via API metadata)

**Verification Needed:**
```bash
curl 'http://localhost:8000/v1/flows?time_window=24h&countries=US' | jq '.metadata.data_source'
# Expected: "real_gdelt" or "placeholder"
```

**Placeholder Detection:**
- Field: `metadata.data_source` = `"placeholder"` | `"real_gdelt"` | `"mixed"`
- Field: `metadata.placeholder_reason` = explanation string
- Currently: All signals have `sources.gdelt_placeholder = true/false` flag

---

## 2. Frontend Layer Architecture

### Classic View vs Heatmap View

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CLASSIC VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                  â”‚
â”‚  Layer Stack (bottom to top):                                   â”‚
â”‚  1. Mapbox Globe (dark-v11)                                     â”‚
â”‚  2. ArcLayer (flows) - WINDS                                    â”‚
â”‚     - widthUnits: 'pixels'                                      â”‚
â”‚     - widthMinPixels: 12                                        â”‚
â”‚     - getWidth: max(15, heat*30) // 15-30px                     â”‚
â”‚     - getHeight: 1.5 // arc elevation                           â”‚
â”‚  3. ScatterplotLayer (nodes) - CENTROIDS                        â”‚
â”‚     - radiusMinPixels: 20                                       â”‚
â”‚     - radiusMaxPixels: 60                                       â”‚
â”‚  4. Mapbox Markers (legacy, still present)                      â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ HEATMAP VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                  â”‚
â”‚  Layer Stack (bottom to top):                                   â”‚
â”‚  1. Mapbox Globe (dark-v11)                                     â”‚
â”‚  2. ArcLayer (flows) - WINDS  (SAME AS CLASSIC)                 â”‚
â”‚  3. HeatmapLayer (gaussian radar) - WEATHER FIELD               â”‚
â”‚     - radiusPixels: 200 // massive blur                         â”‚
â”‚     - intensity: 4                                              â”‚
â”‚     - threshold: 0.01                                           â”‚
â”‚     - colorRange: 6 steps (blue â†’ red)                          â”‚
â”‚     - getPosition: hotspot coords                               â”‚
â”‚     - getWeight: intensity * topic_count                        â”‚
â”‚                                                                  â”‚
â”‚  **PROBLEM:** Not rendering or invisible                        â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Layer Files

| Layer | File | Status | Notes |
|-------|------|--------|-------|
| **Flows (Arcs)** | `frontend/src/components/map/layers/useFlowLayer.ts` | âš ï¸ **BUGGY** | Z-ordering wrong, invisible at global zoom |
| **Heatmap (Gaussian)** | `frontend/src/components/map/layers/useGaussianRadarLayer.ts` | âŒ **BROKEN** | Not rendering |
| **Nodes (Centroids)** | `frontend/src/components/map/layers/useNodeLayer.ts` | âœ… **OK** | Working, shows tooltips |
| **DeckGL Overlay** | `frontend/src/components/map/DeckGLOverlay.tsx` | âœ… **OK** | Interleaved rendering enabled |

---

## 3. Identified Visual Bugs

### Issue #1: Flow Arcs Z-Ordering
**Images:** See uploaded screenshots showing red artifacts floating off Earth

**Problem:**
- Some arcs render at wrong radius/depth
- Visible as red arrowheads or lines floating in space when globe rotates
- Likely caused by incorrect `getHeight` or missing projection alignment

**File:** `frontend/src/components/map/layers/useFlowLayer.ts`, line 48
**Current Code:**
```typescript
getHeight: 1.5,  // Much higher arc (1.5x radius) to avoid clipping into globe
```

**Hypothesis:**
- `getHeight` may be interpreted differently in Globe vs Mercator projection
- Or arc path calculation not accounting for Earth curvature correctly
- Or `greatCircle: true` conflicting with manual height

### Issue #2: Flows Invisible at Global Zoom
**Problem:**
- Despite `widthMinPixels: 12` and `getWidth: max(15, heat*30)`, flows barely visible at zoom level 2
- Only visible when zoomed in significantly

**File:** `frontend/src/components/map/layers/useFlowLayer.ts`, lines 34-40
**Current Code:**
```typescript
widthUnits: 'pixels',     // Width in screen pixels, not meters
widthScale: 1,            // No additional scaling
widthMinPixels: 12,       // Minimum 12px for global visibility
widthMaxPixels: 40,       // Cap at 40px
getWidth: (d: Flow) => Math.max(15, d.heat * 30), // 15-30px for global visibility
```

**Hypothesis:**
- `widthMinPixels` not being respected
- Or opacity too low (currently using default)
- Or color gradient too subtle (cyan â†’ red may blend with dark map at distance)

### Issue #3: Heatmap Layer Not Rendering
**Problem:**
- Gaussian heatmap invisible or not rendering at all
- No error in console
- Layer is created and added to `deckLayers` array (confirmed by logs)

**File:** `frontend/src/components/map/layers/useGaussianRadarLayer.ts`, lines 32-64
**Current Code:**
```typescript
new HeatmapLayer({
    id: 'gaussian-heatmap-layer',
    data: heatmapData,
    visible: true,
    pickable: true,
    radiusPixels: 200,
    intensity: 4,
    threshold: 0.01,
    colorRange: [...], // 6-step gradient
    getPosition: (d: any) => d.position,
    getWeight: (d: any) => d.weight,
    ...
})
```

**Hypotheses:**
1. **Data Format Issue:** `heatmapData` might be empty or malformed
2. **Z-Index:** Heatmap hidden behind other layers
3. **Interleaved Mode:** May not work with HeatmapLayer (aggregation layer)
4. **Globe Projection:** HeatmapLayer may not support globe projection
5. **Weight Too Low:** Intensity calculation might result in invisible heatmap

### Issue #4: Legacy Mapbox Markers Still Present
**Problem:**
- `MapContainer.tsx` still renders Mapbox `<Marker>` components in Classic view (lines 123-150)
- These duplicate the DeckGL `ScatterplotLayer` nodes
- Causes visual clutter and inconsistency

**File:** `frontend/src/components/map/MapContainer.tsx`, lines 123-150

---

## 4. Known Issues from Visual Inspection

Based on uploaded screenshots:

![Classic View - Current State](file:///Users/pedro/.gemini/antigravity/brain/03f10afe-a1a9-4487-b724-bd4bfa4fdb75/uploaded_image_0_1763825789491.png)

**Observations:**
- Blue centroid markers visible and positioned correctly
- No obvious flows visible at this zoom level (confirms invisibility issue)
- Controls UI visible but cluttered (Classic/Heatmap, Time Window, Countries dropdown)
- "Countries" dropdown appears empty/non-functional

![Rotated View - Artifact Visible](file:///Users/pedro/.gemini/antigravity/brain/03f10afe-a1a9-4487-b724-bd4bfa4fdb75/uploaded_image_1_1763825789491.png)

**Critical Finding:**
- **Red arc artifact** visible floating off the globe at wrong z-depth (top-right quadrant)
- This confirms the z-ordering/radius bug
- Arc appears to be at radius >> Earth radius, suggesting incorrect height calculation

---

## 5. Data Quality Assessment

### Backend Data Pipeline

**Current Implementation Status:**

| Component | Status | File | Notes |
|-----------|--------|------|-------|
| GDELT Downloader | âœ… **Implemented** | `backend/app/services/gdelt_downloader.py` | Downloads latest GKG files |
| GDELT Parser | âœ… **Implemented** | `backend/app/services/gdelt_parser.py` | Parses GKG v2.1 schema |
| GDELT Adapter | âœ… **Implemented** | `backend/app/adapters/gdelt_adapter.py` | Converts GKGRecord â†’ GDELTSignal |
| Placeholder Generator | âœ… **Implemented** | `backend/app/services/gdelt_placeholder_generator.py` | Realistic fallback data |
| Flow Detector | âœ… **Implemented** | `backend/app/services/flow_detector.py` | TF-IDF similarity + time decay |
| Signals Service | âœ… **Implemented** | `backend/app/services/signals_service.py` | Orchestrates pipeline, caching |

**Data Source Decision Tree:**
```python
# backend/app/services/gdelt_client.py
1. Try: Download real GDELT GKG file
2. If download fails â†’ Placeholder
3. If parse fails â†’ Placeholder  
4. If conversion fails â†’ Placeholder
5. Success â†’ Cache for 15 min, return real data
```

**Metadata Contract:**
```json
{
  "metadata": {
    "data_source": "placeholder",  // or "real_gdelt"
    "data_quality": "dev_placeholder",  // or "production"
    "placeholder_reason": "GDELT download unavailable or disabled"
  }
}
```

**ACTION REQUIRED (Phase 2):**
- Test API with `curl` to confirm actual data source
- If placeholder: investigate why (network? disabled? auth?)
- If real GDELT: verify data realism (themes, actors, sentiment)

---

## 6. UX/UI Observations

### Current UI Problems

1. **Mode Distinction Unclear:**
   - Classic and Heatmap views look nearly identical
   - Both show same blue markers
   - Heatmap missing its defining feature (the gaussian field)

2. **Control Bar Clutter:**
   - Four separate UI elements: Classic/Heatmap toggle, Time Window, Countries dropdown, Auto-refresh panel
   - "Countries" dropdown appears non-functional (empty?)
   - Auto-refresh panel feels tacked-on, not integrated

3. **"Radar" Branding Mismatch:**
   - UI says "Observatory Global" and "RADAR" but visual doesn't feel like a radar
   - Missing: sweeping motion, intensity gradient pulsing, clear directionality

4. **Narrative List Below Map:**
   - `NarrativeActivityByCountry` section feels disconnected
   - Not clear how it relates to map state
   - Topics/confidence shown but no visual link to hotspots

### Design Philosophy Gap

**Current:** Debug/Developer UI
- Shows all data
- Multiple views/toggles
- Technical language

**Desired:** Product UI
- Coherent "radar" metaphor
- Unified view with progressive disclosure
- "Show me what's hot and why" narrative

---

## 7. Time Window Behavior

### Current Implementation

**Backend:**
```python
# backend/app/api/v1/flows.py
time_window = Query("24h", description="...")
# Parsed to hours in flow_detector
```

**Frontend:**
```typescript
// frontend/src/store/mapStore.ts
timeWindow: TimeWindow  // '1h' | '6h' | '12h' | '24h'
```

**UNKNOWN:**
- Does changing time_window actually filter historical data?
- Or does it only affect in-memory placeholder generation?
- If using real GDELT, are we querying historical files or only latest 15-min window?

**ACTION REQUIRED (Phase 2):**
- Test time window changes with real data
- Verify that `time_window=1h` returns different hotspots than `time_window=24h`
- Check if backed by database or only in-memory cache

---

## 8. Docker Environment Status

```bash
$ docker ps
observatory-web        Up 18 minutes  0.0.0.0:5173->5173/tcp
observatory-api        Up 18 minutes  0.0.0.0:8000->8000/tcp
observatory-postgres   Up 18 minutes  (healthy)
observatory-redis      Up 18 minutes  (healthy)
```

âœ… **All services healthy**

**Database Status:**
- PostgreSQL running and healthy
- Schema exists (from handoff docs: 003_gdelt_signals_schema.sql)
- **NOT INTEGRATED:** Application code doesn't read/write to DB
- All data is ephemeral (in-memory cache only)

---

## 9. Issue Summary by Priority

### ðŸ”´ CRITICAL (Blocks Core Functionality)

1. **Flow Z-Ordering Bug** - Arcs floating off globe
   - **Impact:** Visual corruption, makes flow data unusable
   - **File:** `frontend/src/components/map/layers/useFlowLayer.ts`
   - **Fix Complexity:** Medium (geometry/projection issue)

2. **Heatmap Not Rendering** - Gaussian layer invisible
   - **Impact:** Heatmap view completely broken
   - **File:** `frontend/src/components/map/layers/useGaussianRadarLayer.ts`
   - **Fix Complexity:** Medium-High (could be projection incompatibility)

### ðŸŸ¡ HIGH (Degrades User Experience)

3. **Flows Invisible at Global Zoom**
   - **Impact:** Users can't see flow "winds" without zooming
   - **File:** `useFlowLayer.ts`
   - **Fix Complexity:** Low (likely just opacity/color tuning)

4. **View Modes Look Identical**
   - **Impact:** No clear differentiation between Classic/Heatmap
   - **File:** `MapContainer.tsx` layer logic
   - **Fix Complexity:** Low (conditional layer rendering)

5. **Legacy Marker Duplication**
   - **Impact:** Visual clutter, inconsistency
   - **File:** `MapContainer.tsx` lines 123-150
   - **Fix Complexity:** Trivial (delete Marker components)

### ðŸŸ¢ MEDIUM (Polish/Product Quality)

6. **Control UI Clutter**
   - **Impact:** Feels unpolished
   - **File:** `MapControlBar.tsx`, `AutoRefreshControl.tsx`, etc.
   - **Fix Complexity:** Medium (UX redesign)

7. **Narrative Sidebar Disconnect**
   - **Impact:** Data feels unconnected to visualization
   - **File:** `CountrySidebar.tsx`, list components
   - **Fix Complexity:** Medium (UI/UX redesign)

---

## 10. Data Source Verification Plan

**Immediate Actions (Phase 2):**

1. **Check API Metadata:**
   ```bash
   curl 'http://localhost:8000/v1/flows?time_window=24h&countries=US,BR,CO,MX' | jq '{
     data_source: .metadata.data_source,
     data_quality: .metadata.data_quality,
     placeholder_reason: .metadata.placeholder_reason,
     sample_signal: .hotspots[0].signals[0] | {
       signal_id, persons, organizations, source_outlet
     }
   }'
   ```

2. **Verify Signal Realism:**
   - If `data_source = "real_gdelt"`:
     - Check themes match recent news (e.g., "ECON_INFLATION", "ELECTION")
     - Verify persons are real public figures (not "John Doe")
     - Confirm outlets are real news sources (not placeholder domains)
   - If `data_source = "placeholder"`:
     - Investigate logs: why is GDELT download failing?
     - Check network connectivity, GDELT API status

3. **Time Window Test:**
   ```bash
   # Compare 1h vs 24h - should be different hotspots/flows
   curl '.../flows?time_window=1h' > 1h.json
   curl '.../flows?time_window=24h' > 24h.json
   diff <(jq '.hotspots | length' 1h.json) <(jq '.hotspots | length' 24h.json)
   ```

---

## 11. Phase 0 Conclusions

### What We Learned

1. **Architecture is Sound:**
   - GDELT integration exists and follows design docs
   - Frontend layer approach (DeckGL + Mapbox) is correct
   - Data models align with Phase 3.5 narrative richness

2. **Visual Bugs are Fixable:**
   - Z-ordering issue is localized to `getHeight` calculation
   - Invisibility likely just opacity/color
   - Heatmap may require different layer type or projection handling

3. **Data Pipeline Uncertainty:**
   - Unclear if production is using real GDELT or placeholders
   - Time window behavior not validated
   - No persistent storage (all in-memory)

4. **UX Needs Product Thinking:**
   - Current UI is developer-centric
   - Missing clear "radar" identity
   - Controls need consolidation and polish

### Ready for Phase 1

**Prerequisites Met:**
- âœ… Full system audit complete
- âœ… Visual bugs identified with file/line locations
- âœ… Data pipeline mapped
- âœ… Layer architecture documented

**Next Steps:**
- **Phase 1:** Fix visual bugs (z-ordering, visibility, heatmap)
- **Phase 2:** Verify data pipeline and narrative quality
- **Phase 3:** UX redesign and mode consolidation
- **Phase 4:** Documentation and GitHub cleanup

---

## Appendix: Key File Locations

### Backend
- **GDELT Client:** `backend/app/services/gdelt_client.py`
- **Flow Detector:** `backend/app/services/flow_detector.py`
- **API Endpoint:** `backend/app/api/v1/flows.py`
- **Placeholder Generator:** `backend/app/services/gdelt_placeholder_generator.py`

### Frontend
- **Flow Layer:** `frontend/src/components/map/layers/useFlowLayer.ts`
- **Heatmap Layer:** `frontend/src/components/map/layers/useGaussianRadarLayer.ts`
- **Node Layer:** `frontend/src/components/map/layers/useNodeLayer.ts`
- **Map Container:** `frontend/src/components/map/MapContainer.tsx`
- **DeckGL Overlay:** `frontend/src/components/map/DeckGLOverlay.tsx`
- **Store:** `frontend/src/store/mapStore.ts`

### Documentation
- **GDELT Schema:** `docs/GDELT_SCHEMA_ANALYSIS.md` (1708 lines)
- **Last Handoff:** `docs/state/HANDOFF-2025-01-21.md`
- **Radar Rebuild:** `docs/state/HANDOFF_RADAR_REBUILD.md`

---

**Audit Complete. Proceeding to Phase 1: Visual Correctness Fixes.**
